# Volatility Arbitrage Strategy Configuration - PRODUCTION READY
#
# Best config from ablation testing (Dec 2024):
#   - Return: 227.86% (2019-2024)
#   - Sharpe: 1.38
#   - Max DD: -17.94%
#   - Win Rate: 81%
#   - OOS (2023-24): 24.67%, 31.69% annual returns
#
# Key findings:
#   - Asymmetric targets CRITICAL (removing drops Sharpe to 0.73)
#   - Kelly + DD + Leverage combination is optimal
#   - Term Structure Leverage HURTS when combined with these enhancements

data:
  source: yahoo
  cache_dir: data/cache
  start_date: "2019-01-01"
  end_date: "2024-12-31"
  symbols:
    - SPY  # S&P 500 ETF

backtest:
  initial_capital: 100000.0
  commission_rate: 0.0015  # 0.15% for options (higher than stocks)
  slippage: 0.001  # 0.1% slippage
  position_size_pct: 0.15  # 15% per position (PHASE 1: 3x increase)
  max_positions: 8  # 8 concurrent positions (PHASE 1: +60% capacity)
  risk_free_rate: 0.05  # 5% annual

strategy:
  # Entry/Exit Thresholds
  entry_threshold_pct: 5.0  # Enter when spread >= 5%
  exit_threshold_pct: 2.0   # Exit when spread <= 2%

  # Time Constraints
  min_days_to_expiry: 14  # At least 2 weeks
  max_days_to_expiry: 60  # At most 2 months

  # Delta Hedging
  delta_rebalance_threshold: 0.10  # Rehedge when delta > 0.10
  delta_target: 0.0  # Target delta-neutral

  # Position Sizing
  position_size_pct: 15.0  # 15% of capital per trade (PHASE 1: 3x increase)
  max_vega_exposure: 1000  # Max vega per position
  max_positions: 8  # 8 concurrent positions (PHASE 1: +60% capacity)

  # Volatility Forecasting
  vol_lookback_period: 30  # 30 days for volatility calculation
  vol_forecast_method: "garch"  # garch, ewma, or historical

  # Risk Management
  max_loss_pct: 50.0  # Stop loss at 50% of premium paid

  # ===== QV STRATEGY CONFIGURATION =====
  # Enable the 6-signal consensus model instead of simple IV-RV spread
  use_qv_strategy: true

  # QV Feature Windows
  rv_window: 20           # Realized volatility lookback
  feature_window: 60      # Z-score calculation window
  regime_window: 252      # Vol percentile window

  # QV Signal Thresholds (lowered from original for more signals)
  pc_ratio_threshold: 0.5       # Put/Call ratio z-score threshold
  skew_threshold: 0.5           # IV skew z-score threshold
  premium_threshold: 0.10       # IV premium threshold (10%)
  term_structure_threshold: 0.0 # Term structure threshold
  volume_spike_threshold: 1.0   # Volume spike z-score threshold
  sentiment_threshold: 0.5      # Near-term sentiment z-score threshold

  # QV Consensus Scoring
  consensus_threshold: 0.15     # Minimum consensus for entry (lowered for more trades)

  # QV Signal Weights (sum to 1.0)
  weight_pc_ratio: 0.20
  weight_iv_skew: 0.20
  weight_iv_premium: 0.15
  weight_term_structure: 0.15
  weight_volume_spike: 0.15
  weight_near_term_sentiment: 0.15

  # QV Regime Scalars (position size multipliers by vol percentile) (PHASE 1: relaxed)
  regime_crisis_scalar: 0.6     # Vol >90th percentile (PHASE 1: 0.5 → 0.6)
  regime_elevated_scalar: 0.85  # Vol 70-90th percentile (PHASE 1: 0.75 → 0.85)
  regime_normal_scalar: 1.0     # Vol 30-70th percentile
  regime_low_scalar: 1.3        # Vol 10-30th percentile (PHASE 1: 1.2 → 1.3)
  regime_extreme_low_scalar: 1.8 # Vol <10th percentile (PHASE 1: 1.5 → 1.8)

  # Bullish Base Exposure (removed for pure vol arb)
  base_long_bias: 0.0           # No directional bias (was 0.8)
  signal_adjustment_factor: 1.0 # Full signal weight

  # Tiered Position Sizing
  use_tiered_sizing: true
  min_consensus_threshold: 0.15
  position_scaling_method: quadratic
  min_holding_days: 5

  # ===== ENHANCED RISK MANAGEMENT (NEW) =====
  # NOTE: Set all to false to restore original v1.0 baseline

  # Dynamic Consensus Thresholds (regime-aware) - AGGRESSIVE for more trades
  use_dynamic_threshold: false
  dynamic_threshold:
    crisis_threshold: 0.15      # Even in crisis, take good trades (was 0.20)
    elevated_threshold: 0.12    # Lower threshold in elevated vol (was 0.15)
    normal_threshold: 0.10      # Aggressive in normal conditions (was 0.12)
    low_vol_threshold: 0.08     # Very aggressive in low vol (was 0.10)

  # Drawdown Recovery (position scaling during drawdowns) (PHASE 1: ENABLED)
  use_drawdown_recovery: true
  drawdown_halt_threshold: 0.18  # Halt new trades at 18% drawdown (PHASE 1: 0.12 → 0.18)
  drawdown_thresholds:
    - [0.05, 1.0]    # <5% DD: full size (PHASE 1: relaxed thresholds)
    - [0.08, 0.85]   # 5-8% DD: 85% size
    - [0.12, 0.65]   # 8-12% DD: 65% size
    - [0.15, 0.40]   # 12-15% DD: 40% size
    - [0.18, 0.20]   # 15-18% DD: minimal trading

  # Kelly Criterion Position Sizing (PHASE 1: ENABLED)
  use_kelly_sizing: true
  kelly_fraction: 0.40  # Moderate Kelly (PHASE 1: 0.25 → 0.40)
  kelly_lookback_trades: 50
  kelly_min_trades: 20
  kelly_max_position_pct: 0.25  # Cap individual positions at 25% (PHASE 1: 0.10 → 0.25)
  kelly_min_position_pct: 0.05  # Minimum 5% position (PHASE 1: 0.01 → 0.05)

  # Leverage Configuration (PHASE 2: ENABLED - REDUCED)
  use_leverage: true
  short_vol_leverage: 1.15       # Reduced 1.15x for short vol (was 1.3x)
  long_vol_leverage: 1.5         # Reduced 1.5x for long vol (was 2.0x)
  max_leveraged_notional_pct: 0.80  # 80% max total deployment
  leverage_drawdown_reduction: true
  leverage_dd_threshold: 0.10    # Cut leverage in half at 10% DD

  # Signal Veto Rules (protective filters) (PHASE 1: slightly relaxed)
  use_signal_veto: true                 # ENABLED - filter dangerous trades
  veto_vix_extreme_threshold: 45.0      # Block short vol at VIX > 45 (PHASE 1: 40 → 45)
  veto_vix_spike_threshold: 0.50        # Block after 50% VIX spike
  veto_vix_spike_lookback: 5            # Over 5 days
  veto_backwardation_threshold: -0.15   # Block at 15% backwardation
  veto_signal_disagreement: 4           # Allow 3, block at 4
  veto_regime_crisis_percentile: 0.92   # Block short vol at RV > 92nd percentile (PHASE 1: 0.90 → 0.92)

  # Greeks-Based Exit Rules
  use_greeks_exit: true
  vega_profit_target_multiple: 2.0     # Exit if vega P&L > 2x theta paid
  theta_exit_threshold_pct: -0.03      # Exit if daily theta > 3% of position
  delta_drift_exit_threshold: 0.30     # Exit if |delta| > 0.30

  # Gamma-Aware Rehedging
  use_dynamic_delta_threshold: true
  gamma_threshold_factor: 1.0          # Scaling factor for gamma adjustment
  min_delta_threshold: 0.02            # Never rehedge more often than this
  max_delta_threshold: 0.20            # Always rehedge at this level

  # ===== REGIME DETECTION =====
  # Enable regime-aware trading with HMM/GMM detection
  use_regime_detection: true
  regime_lookback_period: 60  # Days of returns for regime detection
  exit_on_regime_transition: false  # Exit all positions when regime changes

  # ===== STRATEGY ENHANCEMENTS (ABLATION STUDY) =====
  # Each enhancement can be toggled independently for ablation testing
  # Set all to false to restore baseline v1.0

  # Enhancement 1: Regime Transition Signals
  # Detects vol regime CHANGES (LOW→NORMAL, HIGH→NORMAL) as 7th signal
  use_regime_transition_signals: false
  regime_transition:
    low_regime_boundary: 0.30      # Below 30th percentile = low vol
    high_regime_boundary: 0.70     # Above 70th percentile = high vol
    transition_threshold: 0.10     # 10 percentile point change to trigger
    signal_weight: 0.15            # Weight when adding to 6-signal consensus

  # Enhancement 2: Term Structure Leverage
  # Scale position size based on IV term structure slope
  # DATA-CALIBRATED: Term spread typically ranges -1.3% to +1.5% (P10-P90)
  use_term_structure_leverage: false
  term_structure_leverage:
    max_leverage: 2.0              # Maximum leverage cap
    min_leverage: 0.25             # Minimum leverage floor
    steep_contango_threshold: 0.015     # >1.5% = steep contango (P90)
    moderate_contango_threshold: 0.008  # 0.8-1.5% = moderate contango
    mild_contango_threshold: 0.003      # 0.3-0.8% = mild contango
    steep_backwardation_threshold: -0.013  # <-1.3% = steep backwardation (P10)
    extreme_backwardation_threshold: -0.025  # <-2.5% = VETO trade (rare)
    steep_contango_leverage: 2.0
    moderate_contango_leverage: 1.5
    mild_contango_leverage: 1.25
    flat_leverage: 1.0
    mild_backwardation_leverage: 1.0
    moderate_backwardation_leverage: 0.75
    steep_backwardation_leverage: 0.5
    veto_on_extreme_backwardation: true

  # Enhancement 3: Vol-of-Vol (VVIX) Integration
  # Use estimated VVIX as position sizing modifier
  # DATA-CALIBRATED: VoV typically ranges 0.6% to 1.3% (P25-P75)
  use_vov_signal: false
  vov_signal:
    lookback_days: 20              # Days to calculate IV volatility
    high_vov_threshold: 0.013      # VoV > 1.3% = high vol-of-vol (P75)
    low_vov_threshold: 0.006       # VoV < 0.6% = low vol-of-vol (P25)
    high_vov_long_scalar: 1.3      # Boost long vol when VoV high
    high_vov_short_scalar: 0.7     # Reduce short vol when VoV high
    low_vov_short_scalar: 1.2      # Boost short vol when VoV low
    low_vov_long_scalar: 0.8       # Reduce long vol when VoV low

  # Enhancement 4: Intraday Volatility Patterns
  # Decompose RV into overnight vs intraday components
  use_intraday_vol_decomposition: false
  intraday_vol:
    lookback_days: 20              # Days for decomposition calculation
    overnight_dominant_threshold: 1.5   # Overnight/Intraday > 1.5 = news-driven
    intraday_dominant_threshold: 0.67   # Overnight/Intraday < 0.67 = orderly
    overnight_dominant_scalar: 0.75     # Reduce size when overnight dominant
    intraday_dominant_scalar: 1.1       # Boost size when intraday dominant

  # Enhancement 5: Dynamic Signal Weighting (ML Ensemble)
  # Adapt signal weights based on recent accuracy (EMA)
  use_dynamic_weighting: false
  dynamic_weighting:
    ema_decay: 0.95                # EMA decay factor (0.95 = slow adaptation)
    min_weight: 0.05               # Minimum weight per signal (5%)
    max_weight: 0.40               # Maximum weight per signal (40%)
    min_samples_for_adaptation: 20 # Trades before enabling adaptation
    neutral_accuracy: 0.50         # Accuracy that maps to neutral weight

  # Enhancement 6: Asymmetric Profit Taking (PHASE 1: ENABLED)
  # Different profit targets and stop losses for long vs short vol
  # Tighter stops to compensate for future leverage
  use_asymmetric_targets: true
  asymmetric_targets:
    short_vol_profit_target: 0.04   # +4% profit target (PHASE 1: tighter)
    short_vol_stop_loss: -0.04      # -4% stop loss (PHASE 1: tighter, will be -5.2% with 1.3x leverage in Phase 2)
    long_vol_profit_target: 0.06    # +6% profit target
    long_vol_stop_loss: -0.03       # -3% stop loss (PHASE 1: tighter, will be -6% with 2.0x leverage in Phase 2)

  # Enhancement 7: Alternative RV Methods
  # Use more efficient RV estimators (Parkinson, Garman-Klass, Yang-Zhang)
  rv_method: close_to_close        # Options: close_to_close, parkinson, garman_klass, yang_zhang, ensemble
  rv_use_ensemble: false           # Average multiple methods

  # Regime-Specific Parameters
  # Maps regime_id to entry/exit thresholds and position sizing
  # Regime 0: Low volatility - tighter thresholds, larger positions
  # Regime 1: Medium volatility - baseline parameters
  # Regime 2: High volatility - wider thresholds, smaller positions
  regime_params:
    0:  # Low volatility regime
      entry_threshold_pct: 3.0  # Enter at 3% spread (more aggressive)
      exit_threshold_pct: 1.5   # Exit at 1.5% spread
      position_size_multiplier: 1.5  # 50% larger positions
      max_vega_multiplier: 1.5
    1:  # Medium volatility regime
      entry_threshold_pct: 5.0  # Baseline threshold
      exit_threshold_pct: 2.0   # Baseline exit
      position_size_multiplier: 1.0  # Baseline size
      max_vega_multiplier: 1.0
    2:  # High volatility regime
      entry_threshold_pct: 8.0  # Enter at 8% spread (more conservative)
      exit_threshold_pct: 3.0   # Exit at 3% spread
      position_size_multiplier: 0.5  # 50% smaller positions
      max_vega_multiplier: 0.5

# Options Data Quality Filters
options:
  min_volume: 10  # Minimum daily volume
  min_open_interest: 50  # Minimum open interest
  max_spread_pct: 0.20  # Max 20% bid-ask spread

volatility:
  method: garch
  lookback_period: 30
  ewma_lambda: 0.94
  garch_p: 1
  garch_q: 1

logging:
  level: INFO
  format: json
  log_dir: logs
  console_output: true
