# Volatility Arbitrage Strategy Configuration

data:
  source: yahoo
  cache_dir: data/cache
  start_date: "2023-01-01"
  end_date: "2024-01-01"
  symbols:
    - SPY  # S&P 500 ETF

backtest:
  initial_capital: 100000.0
  commission_rate: 0.0015  # 0.15% for options (higher than stocks)
  slippage: 0.001  # 0.1% slippage
  position_size_pct: 0.05  # 5% per position
  max_positions: 5
  risk_free_rate: 0.05  # 5% annual

strategy:
  # Entry/Exit Thresholds
  entry_threshold_pct: 5.0  # Enter when spread >= 5%
  exit_threshold_pct: 2.0   # Exit when spread <= 2%

  # Time Constraints
  min_days_to_expiry: 14  # At least 2 weeks
  max_days_to_expiry: 60  # At most 2 months

  # Delta Hedging
  delta_rebalance_threshold: 0.10  # Rehedge when delta > 0.10
  delta_target: 0.0  # Target delta-neutral

  # Position Sizing
  position_size_pct: 5.0  # 5% of capital per trade
  max_vega_exposure: 1000  # Max vega per position
  max_positions: 5

  # Volatility Forecasting
  vol_lookback_period: 30  # 30 days for volatility calculation
  vol_forecast_method: "garch"  # garch, ewma, or historical

  # Risk Management
  max_loss_pct: 50.0  # Stop loss at 50% of premium paid

  # ===== QV STRATEGY CONFIGURATION =====
  # Enable the 6-signal consensus model instead of simple IV-RV spread
  use_qv_strategy: true

  # QV Feature Windows
  rv_window: 20           # Realized volatility lookback
  feature_window: 60      # Z-score calculation window
  regime_window: 252      # Vol percentile window

  # QV Signal Thresholds (lowered from original for more signals)
  pc_ratio_threshold: 0.5       # Put/Call ratio z-score threshold
  skew_threshold: 0.5           # IV skew z-score threshold
  premium_threshold: 0.10       # IV premium threshold (10%)
  term_structure_threshold: 0.0 # Term structure threshold
  volume_spike_threshold: 1.0   # Volume spike z-score threshold
  sentiment_threshold: 0.5      # Near-term sentiment z-score threshold

  # QV Consensus Scoring
  consensus_threshold: 0.15     # Minimum consensus for entry (lowered for more trades)

  # QV Signal Weights (sum to 1.0)
  weight_pc_ratio: 0.20
  weight_iv_skew: 0.20
  weight_iv_premium: 0.15
  weight_term_structure: 0.15
  weight_volume_spike: 0.15
  weight_near_term_sentiment: 0.15

  # QV Regime Scalars (position size multipliers by vol percentile)
  regime_crisis_scalar: 0.5     # Vol >90th percentile - reduce size
  regime_elevated_scalar: 0.75  # Vol 70-90th percentile
  regime_normal_scalar: 1.0     # Vol 30-70th percentile
  regime_low_scalar: 1.2        # Vol 10-30th percentile
  regime_extreme_low_scalar: 1.5 # Vol <10th percentile - increase size

  # Bullish Base Exposure (removed for pure vol arb)
  base_long_bias: 0.0           # No directional bias (was 0.8)
  signal_adjustment_factor: 1.0 # Full signal weight

  # Tiered Position Sizing
  use_tiered_sizing: true
  min_consensus_threshold: 0.15
  position_scaling_method: quadratic
  min_holding_days: 5

  # ===== ENHANCED RISK MANAGEMENT (NEW) =====
  # NOTE: Set all to false to restore original v1.0 baseline

  # Dynamic Consensus Thresholds (regime-aware) - AGGRESSIVE for more trades
  use_dynamic_threshold: false
  dynamic_threshold:
    crisis_threshold: 0.15      # Even in crisis, take good trades (was 0.20)
    elevated_threshold: 0.12    # Lower threshold in elevated vol (was 0.15)
    normal_threshold: 0.10      # Aggressive in normal conditions (was 0.12)
    low_vol_threshold: 0.08     # Very aggressive in low vol (was 0.10)

  # Drawdown Recovery (position scaling during drawdowns)
  use_drawdown_recovery: false
  drawdown_halt_threshold: 0.12  # Halt new trades at 12% drawdown
  drawdown_thresholds:
    - [0.02, 1.0]    # <2% DD: full size
    - [0.04, 0.75]   # 2-4% DD: 75% size
    - [0.06, 0.50]   # 4-6% DD: 50% size
    - [0.08, 0.25]   # 6-8% DD: 25% size
    - [0.10, 0.10]   # 8-10% DD: minimal trading

  # Kelly Criterion Position Sizing - DISABLED to match original
  use_kelly_sizing: false
  kelly_fraction: 0.25
  kelly_lookback_trades: 50
  kelly_min_trades: 20
  kelly_max_position_pct: 0.10
  kelly_min_position_pct: 0.01

  # Signal Veto Rules (protective filters) - BALANCED FOR QUALITY + RETURNS
  use_signal_veto: true                 # ENABLED - filter dangerous trades
  veto_vix_extreme_threshold: 40.0      # Block short vol at VIX > 40
  veto_vix_spike_threshold: 0.50        # Block after 50% VIX spike (relaxed - was 30%)
  veto_vix_spike_lookback: 5            # Over 5 days
  veto_backwardation_threshold: -0.15   # Block at 15% backwardation
  veto_signal_disagreement: 4           # Allow 3, block at 4 (relaxed for more trades)
  veto_regime_crisis_percentile: 0.90   # Block short vol at RV > 90th percentile

  # Greeks-Based Exit Rules
  use_greeks_exit: true
  vega_profit_target_multiple: 2.0     # Exit if vega P&L > 2x theta paid
  theta_exit_threshold_pct: -0.03      # Exit if daily theta > 3% of position
  delta_drift_exit_threshold: 0.30     # Exit if |delta| > 0.30

  # Gamma-Aware Rehedging
  use_dynamic_delta_threshold: true
  gamma_threshold_factor: 1.0          # Scaling factor for gamma adjustment
  min_delta_threshold: 0.02            # Never rehedge more often than this
  max_delta_threshold: 0.20            # Always rehedge at this level

  # ===== REGIME DETECTION =====
  # Enable regime-aware trading with HMM/GMM detection
  use_regime_detection: true
  regime_lookback_period: 60  # Days of returns for regime detection
  exit_on_regime_transition: false  # Exit all positions when regime changes

  # Regime-Specific Parameters
  # Maps regime_id to entry/exit thresholds and position sizing
  # Regime 0: Low volatility - tighter thresholds, larger positions
  # Regime 1: Medium volatility - baseline parameters
  # Regime 2: High volatility - wider thresholds, smaller positions
  regime_params:
    0:  # Low volatility regime
      entry_threshold_pct: 3.0  # Enter at 3% spread (more aggressive)
      exit_threshold_pct: 1.5   # Exit at 1.5% spread
      position_size_multiplier: 1.5  # 50% larger positions
      max_vega_multiplier: 1.5
    1:  # Medium volatility regime
      entry_threshold_pct: 5.0  # Baseline threshold
      exit_threshold_pct: 2.0   # Baseline exit
      position_size_multiplier: 1.0  # Baseline size
      max_vega_multiplier: 1.0
    2:  # High volatility regime
      entry_threshold_pct: 8.0  # Enter at 8% spread (more conservative)
      exit_threshold_pct: 3.0   # Exit at 3% spread
      position_size_multiplier: 0.5  # 50% smaller positions
      max_vega_multiplier: 0.5

# Options Data Quality Filters
options:
  min_volume: 10  # Minimum daily volume
  min_open_interest: 50  # Minimum open interest
  max_spread_pct: 0.20  # Max 20% bid-ask spread

volatility:
  method: garch
  lookback_period: 30
  ewma_lambda: 0.94
  garch_p: 1
  garch_q: 1

logging:
  level: INFO
  format: json
  log_dir: logs
  console_output: true
