# Test: Kelly + Drawdown Recovery (no asymmetric)

data:
  source: yahoo
  cache_dir: data/cache
  start_date: "2023-01-01"
  end_date: "2024-01-01"
  symbols:
    - SPY

backtest:
  initial_capital: 100000.0
  commission_rate: 0.0015
  slippage: 0.001
  position_size_pct: 0.05
  max_positions: 5
  risk_free_rate: 0.05

strategy:
  entry_threshold_pct: 5.0
  exit_threshold_pct: 2.0
  min_days_to_expiry: 14
  max_days_to_expiry: 60
  delta_rebalance_threshold: 0.10
  delta_target: 0.0
  position_size_pct: 15.0
  max_vega_exposure: 1500
  max_positions: 8
  vol_lookback_period: 30
  vol_forecast_method: "garch"
  max_loss_pct: 50.0

  use_qv_strategy: true
  rv_window: 20
  feature_window: 60
  regime_window: 252
  pc_ratio_threshold: 0.5
  skew_threshold: 0.5
  premium_threshold: 0.10
  term_structure_threshold: 0.0
  volume_spike_threshold: 1.0
  sentiment_threshold: 0.5
  consensus_threshold: 0.15

  weight_pc_ratio: 0.15
  weight_iv_skew: 0.16
  weight_iv_premium: 0.24
  weight_term_structure: 0.17
  weight_volume_spike: 0.10
  weight_near_term_sentiment: 0.18

  regime_crisis_scalar: 0.3
  regime_elevated_scalar: 0.6
  regime_normal_scalar: 1.0
  regime_low_scalar: 1.5
  regime_extreme_low_scalar: 2.0

  base_long_bias: 0.0
  signal_adjustment_factor: 1.0
  use_tiered_sizing: true
  min_consensus_threshold: 0.15
  position_scaling_method: quadratic
  min_holding_days: 5

  # KELLY - ENABLED
  use_kelly_sizing: true
  kelly_fraction: 0.40
  kelly_lookback_trades: 50
  kelly_min_trades: 20
  kelly_max_position_pct: 0.25
  kelly_min_position_pct: 0.02

  # DRAWDOWN RECOVERY - ENABLED
  use_drawdown_recovery: true
  drawdown_halt_threshold: 0.18
  drawdown_thresholds:
    - [0.02, 1.0]
    - [0.04, 0.75]
    - [0.06, 0.50]
    - [0.08, 0.25]
    - [0.10, 0.10]

  # Asymmetric - DISABLED
  use_asymmetric_targets: false
  asymmetric_targets:
    short_vol_profit_target: 0.04
    short_vol_stop_loss: -0.04
    long_vol_profit_target: 0.06
    long_vol_stop_loss: -0.03

  use_dynamic_threshold: false
  dynamic_threshold:
    crisis_threshold: 0.15
    elevated_threshold: 0.12
    normal_threshold: 0.10
    low_vol_threshold: 0.08

  use_signal_veto: true
  veto_vix_extreme_threshold: 40.0
  veto_vix_spike_threshold: 0.50
  veto_vix_spike_lookback: 5
  veto_backwardation_threshold: -0.15
  veto_signal_disagreement: 4
  veto_regime_crisis_percentile: 0.90

  use_greeks_exit: true
  vega_profit_target_multiple: 2.0
  theta_exit_threshold_pct: -0.03
  delta_drift_exit_threshold: 0.30

  use_dynamic_delta_threshold: true
  gamma_threshold_factor: 1.0
  min_delta_threshold: 0.02
  max_delta_threshold: 0.20

  use_regime_detection: true
  regime_lookback_period: 60
  exit_on_regime_transition: false

  use_regime_transition_signals: false
  regime_transition:
    low_regime_boundary: 0.30
    high_regime_boundary: 0.70
    transition_threshold: 0.10
    signal_weight: 0.15

  use_term_structure_leverage: false
  term_structure_leverage:
    max_leverage: 2.0
    min_leverage: 0.25
    steep_contango_threshold: 0.015
    moderate_contango_threshold: 0.008
    mild_contango_threshold: 0.003
    steep_backwardation_threshold: -0.013
    extreme_backwardation_threshold: -0.025
    steep_contango_leverage: 2.0
    moderate_contango_leverage: 1.5
    mild_contango_leverage: 1.25
    flat_leverage: 1.0
    mild_backwardation_leverage: 1.0
    moderate_backwardation_leverage: 0.75
    steep_backwardation_leverage: 0.5
    veto_on_extreme_backwardation: true

  use_vov_signal: false
  vov_signal:
    lookback_days: 20
    high_vov_threshold: 0.013
    low_vov_threshold: 0.006
    high_vov_long_scalar: 1.3
    high_vov_short_scalar: 0.7
    low_vov_short_scalar: 1.2
    low_vov_long_scalar: 0.8

  use_intraday_vol_decomposition: false
  intraday_vol:
    lookback_days: 20
    overnight_dominant_threshold: 1.5
    intraday_dominant_threshold: 0.67
    overnight_dominant_scalar: 0.75
    intraday_dominant_scalar: 1.1

  use_dynamic_weighting: false
  dynamic_weighting:
    ema_decay: 0.95
    min_weight: 0.05
    max_weight: 0.40
    min_samples_for_adaptation: 20
    neutral_accuracy: 0.50

  rv_method: close_to_close
  rv_use_ensemble: false

  use_leverage: true
  short_vol_leverage: 1.15
  long_vol_leverage: 1.5

  regime_params:
    0:
      entry_threshold_pct: 3.0
      exit_threshold_pct: 1.5
      position_size_multiplier: 1.5
      max_vega_multiplier: 1.5
    1:
      entry_threshold_pct: 5.0
      exit_threshold_pct: 2.0
      position_size_multiplier: 1.0
      max_vega_multiplier: 1.0
    2:
      entry_threshold_pct: 8.0
      exit_threshold_pct: 3.0
      position_size_multiplier: 0.5
      max_vega_multiplier: 0.5

options:
  min_volume: 10
  min_open_interest: 50
  max_spread_pct: 0.20

volatility:
  method: garch
  lookback_period: 30
  ewma_lambda: 0.94
  garch_p: 1
  garch_q: 1

logging:
  level: INFO
  format: json
  log_dir: logs
  console_output: true
